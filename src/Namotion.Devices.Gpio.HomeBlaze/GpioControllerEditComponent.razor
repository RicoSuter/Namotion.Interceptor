@using Namotion.Interceptor

@attribute [SubjectComponent(SubjectComponentType.Edit, typeof(GpioController))]

@implements ISubjectComponent

<MudStack Spacing="4">
    <MudText Typo="Typo.h6">GPIO Configuration</MudText>

    <MudExpansionPanels>
        @* MCP3008 ADC Section *@
        <MudExpansionPanel Text="MCP3008 ADC (SPI)">
            <MudStack Spacing="2">
                <MudSwitch T="bool" Value="@(GpioController?.Mcp3008 != null)" ValueChanged="@OnMcp3008EnabledChanged" Label="Enable MCP3008" Color="Color.Primary" />

                @if (GpioController?.Mcp3008 != null)
                {
                    <MudNumericField T="int" @bind-Value="GpioController.Mcp3008.ClockPin" Label="Clock Pin" />
                    <MudNumericField T="int" @bind-Value="GpioController.Mcp3008.MosiPin" Label="MOSI Pin" />
                    <MudNumericField T="int" @bind-Value="GpioController.Mcp3008.MisoPin" Label="MISO Pin" />
                    <MudNumericField T="int" @bind-Value="GpioController.Mcp3008.ChipSelectPin" Label="Chip Select Pin" />
                }
            </MudStack>
        </MudExpansionPanel>

        @* ADS1115 ADC Section *@
        <MudExpansionPanel Text="ADS1115 ADC (I2C)">
            <MudStack Spacing="2">
                <MudSwitch T="bool" Value="@(GpioController?.Ads1115 != null)" ValueChanged="@OnAds1115EnabledChanged" Label="Enable ADS1115" Color="Color.Primary" />

                @if (GpioController?.Ads1115 != null)
                {
                    <MudNumericField T="int" @bind-Value="GpioController.Ads1115.I2cBus" Label="I2C Bus" />
                    <MudNumericField T="int" @bind-Value="GpioController.Ads1115.Address" Label="I2C Address" />
                }
            </MudStack>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <MudAlert Severity="Severity.Info" Class="mt-2">
        Digital pins and analog channels are managed through the browser panel.
    </MudAlert>

    <MudDivider Class="my-4" />

    <MudSwitch T="bool"
        Value="@(GpioController?.UseSimulation ?? false)"
        ValueChanged="@OnSimulationChanged"
        Label="Use Simulation Mode"
        Color="Color.Secondary" />
    <MudText Typo="Typo.caption" Class="ml-12 mt-n2">
        Creates 28 simulated GPIO pins for testing on non-Pi hardware.
    </MudText>
</MudStack>

@code {
    [Parameter]
    public IInterceptorSubject? Subject { get; set; }

    [Parameter]
    public bool IsCreating { get; set; }

    private GpioController? GpioController => Subject as GpioController;

    private void OnMcp3008EnabledChanged(bool enabled)
    {
        GpioController?.Mcp3008 = enabled ? new Mcp3008Configuration() : null;
    }

    private void OnAds1115EnabledChanged(bool enabled)
    {
        GpioController?.Ads1115 = enabled ? new Ads1115Configuration() : null;
    }

    private void OnSimulationChanged(bool enabled)
    {
        GpioController?.UseSimulation = enabled;
    }
}
