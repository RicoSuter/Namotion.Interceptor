@page "/set-password/{UserId}"

@using HomeBlaze.Authorization.Blazor.Utilities

@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">@(RequiresTempPassword ? "Reset Password" : "Set Password")</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @(RequiresTempPassword
                        ? "Enter your temporary password and choose a new password."
                        : "Please set a password for your account.")
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@ErrorMessage</MudAlert>
            }

            <form method="post" action="/api/auth/set-password">
                <AntiforgeryToken />
                <input type="hidden" name="UserId" value="@UserId" />
                <input type="hidden" name="TempPassword" value="@_tempPassword" />
                <input type="hidden" name="Password" value="@_password" />
                <input type="hidden" name="ConfirmPassword" value="@_confirmPassword" />

                @if (RequiresTempPassword)
                {
                    <MudTextField T="string"
                                  Label="Temporary Password"
                                  @bind-Value="_tempPassword"
                                  Immediate="true"
                                  InputType="InputType.Password"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  HelperText="Enter the temporary password provided by your administrator"
                                  Class="mb-4" />
                }

                <MudTextField T="string"
                              Label="New Password"
                              @bind-Value="_password"
                              Immediate="true"
                              InputType="InputType.Password"
                              Variant="Variant.Outlined"
                              Required="true"
                              HelperText="@GetPasswordHelperText()"
                              Error="@(!string.IsNullOrEmpty(_password) && !IsPasswordValid())"
                              Class="mb-2" />

                @if (!string.IsNullOrEmpty(_password))
                {
                    <MudProgressLinear Color="@GetStrengthColor()" Value="@GetStrengthValue()" Class="mb-4" />
                }

                <MudTextField T="string"
                              Label="Confirm Password"
                              @bind-Value="_confirmPassword"
                              Immediate="true"
                              InputType="InputType.Password"
                              Variant="Variant.Outlined"
                              Required="true"
                              Error="@(!string.IsNullOrEmpty(_confirmPassword) && _password != _confirmPassword)"
                              ErrorText="Passwords do not match"
                              Class="mb-4" />

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Disabled="@(!CanSubmit())">
                    Set Password
                </MudButton>
            </form>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [Parameter]
    public string UserId { get; set; } = "";

    [SupplyParameterFromQuery]
    public string? ErrorMessage { get; set; }

    [SupplyParameterFromQuery]
    public bool RequiresTempPassword { get; set; }

    private string _tempPassword = "";
    private string _password = "";
    private string _confirmPassword = "";

    private bool IsPasswordValid() => PasswordStrengthUtility.IsValid(_password);

    private bool CanSubmit()
    {
        // If temp password is required, it must be provided
        if (RequiresTempPassword && string.IsNullOrEmpty(_tempPassword))
            return false;

        return IsPasswordValid() &&
               !string.IsNullOrEmpty(_confirmPassword) &&
               _password == _confirmPassword;
    }

    private string GetPasswordHelperText() => PasswordStrengthUtility.GetHelperText(_password);

    private int GetStrengthValue() => PasswordStrengthUtility.GetStrengthPercentage(_password);

    private Color GetStrengthColor() => PasswordStrengthUtility.GetStrengthColor(_password);
}
