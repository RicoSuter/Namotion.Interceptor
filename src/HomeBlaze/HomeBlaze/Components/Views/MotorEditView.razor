@using HomeBlaze.Abstractions.Attributes
@using HomeBlaze.Abstractions.Views
@using HomeBlaze.Core.Subjects

@attribute [SubjectView("edit", typeof(Motor))]
@implements ISubjectEditView

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h6" Class="mb-4">Edit Motor</MudText>

    <MudTextField @bind-Value="_name"
                  Label="Name"
                  Required="true"
                  RequiredError="Name is required"
                  Immediate="true"
                  OnKeyUp="OnFieldChanged" />

    <MudNumericField @bind-Value="_targetSpeed"
                     Label="Target Speed (RPM)"
                     Min="0"
                     Max="10000"
                     Class="mt-4" />

    <MudNumericField @bind-Value="_simulationIntervalMs"
                     Label="Simulation Interval (ms)"
                     Min="100"
                     Max="10000"
                     Class="mt-4" />

    <MudDivider Class="my-4" />

    <MudText Typo="Typo.subtitle2" Class="mb-2">Current State (Read-only)</MudText>
    <MudText>Current Speed: @Subject?.CurrentSpeed RPM</MudText>
    <MudText>Temperature: @Subject?.Temperature.ToString("F1")Â°C</MudText>
    <MudText>Status: @Subject?.Status</MudText>
</MudPaper>

@code {
    [Parameter]
    public Motor? Subject { get; set; }

    private string _name = string.Empty;
    private int _targetSpeed;
    private int _simulationIntervalMs;

    private string _originalName = string.Empty;
    private int _originalTargetSpeed;
    private int _originalSimulationIntervalMs;

    public bool IsValid => !string.IsNullOrWhiteSpace(_name);
    public bool IsDirty => _name != _originalName ||
                           _targetSpeed != _originalTargetSpeed ||
                           _simulationIntervalMs != _originalSimulationIntervalMs;

    public event Action<bool>? IsValidChanged;
    public event Action<bool>? IsDirtyChanged;

    protected override void OnParametersSet()
    {
        if (Subject != null)
        {
            _name = Subject.Name ?? string.Empty;
            _targetSpeed = Subject.TargetSpeed;
            _simulationIntervalMs = (int)Subject.SimulationInterval.TotalMilliseconds;

            _originalName = _name;
            _originalTargetSpeed = _targetSpeed;
            _originalSimulationIntervalMs = _simulationIntervalMs;
        }
    }

    private void OnFieldChanged()
    {
        IsValidChanged?.Invoke(IsValid);
        IsDirtyChanged?.Invoke(IsDirty);
    }

    public Task SaveAsync()
    {
        if (Subject != null && IsValid)
        {
            Subject.Name = _name;
            Subject.TargetSpeed = _targetSpeed;
            Subject.SimulationInterval = TimeSpan.FromMilliseconds(_simulationIntervalMs);

            _originalName = _name;
            _originalTargetSpeed = _targetSpeed;
            _originalSimulationIntervalMs = _simulationIntervalMs;

            IsDirtyChanged?.Invoke(false);
        }
        return Task.CompletedTask;
    }
}
