@page "/pages/{*Path}"

@using HomeBlaze.Abstractions
@using HomeBlaze.Abstractions.Attributes
@using HomeBlaze.Host.Components.Dialogs
@using HomeBlaze.Host.Components.Editors
@using HomeBlaze.Host.Services.Components
@using Namotion.Interceptor.Blazor

@inherits HomeBlazorComponentBase

@inject SubjectComponentRegistry ComponentRegistry
@inject RoutePathResolver RouteResolver
@inject IDialogService DialogService
@inject DeveloperModeService DeveloperMode

<PageTitle>@_title - HomeBlaze</PageTitle>

<TrackingScope Context="_subject?.Context" ShowDebugInfo="DeveloperMode.IsEnabled">
    @if (_subject == null)
    {
        <MudAlert Severity="Severity.Warning">Subject not found at path: @Path</MudAlert>
    }
    else
    {
        @if (CanEdit())
        {
            <MudFab Style="position: fixed; top: 80px; right: 24px; z-index: 1000;"
                    OnClick="@ToggleEditMode"
                    StartIcon="@Icons.Material.Filled.Edit"
                    Color="Color.Primary"
                    Size="Size.Small"/>
        }

        if (_isEditMode && CanEdit())
        {
            <MudSplitter @bind-Dimension="_splitDimension"
                         Height="calc(100vh - 80px)"
                         EnableSlide="true"
                         OnDoubleClicked="ResetSplitDimension">
                <StartContent>
                    @if (_componentType != null)
                    {
                        <div style="width: 100%">
                            <DynamicComponent @key="_componentKey" Type="_componentType"
                                              Parameters="@(new Dictionary<string, object?> { ["Subject"] = _subject })"/>
                        </div>
                    }
                    else
                    {
                        <MudText>No page component registered for @_subject.GetType().Name</MudText>
                    }
                </StartContent>
                <EndContent>
                    <div style="width: 100%">
                        <br />
                        <br />
                        <br />
                        <SubjectEditPanel Subject="@_subject"
                                          Height="calc(100vh - 200px)"
                                          ShowCancelButton="false"
                                          OnSaved="OnEditSaved"/>
                    </div>
                </EndContent>
            </MudSplitter>
        }
        else
        {
            @if (_componentType != null)
            {
                <DynamicComponent @key="_componentKey" Type="_componentType"
                                  Parameters="@(new Dictionary<string, object?> { ["Subject"] = _subject })"/>
            }
            else
            {
                <MudText>No page component registered for @_subject.GetType().Name</MudText>
            }
        }
    }
</TrackingScope>

@code {
    [Parameter] public string? Path { get; set; }

    private IInterceptorSubject? _subject;
    private Type? _componentType;
    private string _title = "";
    private int _componentKey;
    private bool _isEditMode;
    private double _splitDimension = 50;

    protected override void OnParametersSet()
    {
        LoadSubject();

        // Close edit mode when navigating to a different page
        _isEditMode = false;
    }

    private void LoadSubject()
    {
        _subject = null;
        _componentType = null;
        _title = "";

        if (Root == null)
            return;

        // Ensure root is registered by accessing a property
        if (Root is FluentStorageContainer storage)
        {
            _ = storage.Children; // Trigger registration
        }

        _subject = RouteResolver.ResolveFromRoute(Path ?? "");

        if (_subject != null)
        {
            var registration = ComponentRegistry.GetComponent(
                _subject.GetType(),
                SubjectComponentType.Page);

            _componentType = registration?.ComponentType;

            // Get title from ITitleProvider if implemented
            if (_subject is ITitleProvider titleProvider)
            {
                _title = titleProvider.Title ?? _subject.GetType().Name;
            }
            else
            {
                _title = _subject.GetType().Name;
            }
        }
    }

    private bool CanEdit()
    {
        if (_subject == null) return false;

        // Can edit if there's a custom edit component or configuration properties
        var hasEditComponent = ComponentRegistry.HasComponent(
            _subject.GetType(),
            SubjectComponentType.Edit);

        return hasEditComponent || _subject.HasConfigurationProperties();
    }

    private void ToggleEditMode()
    {
        _isEditMode = !_isEditMode;
    }

    private void OnEditSaved()
    {
        // Increment key to refresh page component with saved changes
        _componentKey++;
        StateHasChanged();
    }

    private void ResetSplitDimension()
    {
        _splitDimension = 50;
    }

}
