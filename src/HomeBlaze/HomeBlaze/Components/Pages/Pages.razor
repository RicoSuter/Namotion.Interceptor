@page "/pages/{*Path}"

@using HomeBlaze.Abstractions
@using HomeBlaze.Components.Dialogs
@using HomeBlaze.Core.Components
@using HomeBlaze.Core.Pages
@using Namotion.Interceptor.Registry.Abstractions

@inherits HomeBlazorComponentBase

@inject SubjectComponentRegistry ComponentRegistry
@inject IDialogService DialogService

<PageTitle>@_title - HomeBlaze</PageTitle>

<MudStack Row="true" Class="mb-4" AlignItems="AlignItems.Center">
    <MudText Typo="Typo.h4">@_title</MudText>
    <MudSpacer />
    @if (CanEdit())
    {
        <MudIconButton OnClick="@OpenEditDialog"
                       Icon="@Icons.Material.Filled.Edit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small" />
    }
</MudStack>

@if (_subject == null)
{
    <MudAlert Severity="Severity.Warning">Subject not found at path: @Path</MudAlert>
}
else if (_componentType != null)
{
    <DynamicComponent @key="_componentKey" Type="_componentType"
        Parameters="@(new Dictionary<string, object?> { ["Subject"] = _subject })" />
}
else
{
    <MudText>No page component registered for @_subject.GetType().Name</MudText>
}

@code {
    [Parameter]
    public string? Path { get; set; }

    private IInterceptorSubject? _subject;
    private Type? _componentType;
    private string _title = "";
    private int _componentKey;

    protected override void OnParametersSet()
    {
        LoadSubject();
    }

    private void LoadSubject()
    {
        _subject = null;
        _componentType = null;
        _title = "";

        EnableTracking = false;
        if (Root == null)
            return;

        var registry = RootContext?.GetService<ISubjectRegistry>();
        if (registry == null)
            return;

        // Ensure root is registered by accessing a property
        if (Root is FluentStorageContainer storage)
        {
            _ = storage.Children; // Trigger registration
        }

        _subject = SubjectPathResolver.ResolveSubject(Root, registry, Path ?? "");

        if (_subject != null)
        {
            var registration = ComponentRegistry.GetComponent(
                _subject.GetType(),
                SubjectComponentType.Page);
            _componentType = registration?.ComponentType;

            // Get title from IDisplaySubject if implemented
            if (_subject is IDisplaySubject displayable)
            {
                _title = displayable.Title ?? _subject.GetType().Name;
            }
            else
            {
                _title = _subject.GetType().Name;
            }
        }
    }

    private bool CanEdit()
    {
        if (_subject == null) return false;

        // Can edit if there's a custom edit component or configuration properties
        var hasEditComponent = ComponentRegistry.HasComponent(
            _subject.GetType(),
            SubjectComponentType.Edit);

        return hasEditComponent || _subject.HasConfigurationProperties();
    }

    private async Task OpenEditDialog()
    {
        if (_subject == null) return;

        var parameters = new DialogParameters<SubjectEditDialog>
        {
            { x => x.Subject, _subject }
        };

        // Check if custom edit component exists to determine dialog size
        var editRegistration = ComponentRegistry.GetComponent(
            _subject.GetType(),
            SubjectComponentType.Edit);

        var maxWidth = editRegistration != null ? MaxWidth.Large : MaxWidth.Small;

        var options = new DialogOptions
        {
            MaxWidth = maxWidth,
            FullWidth = true,
            CloseButton = true
        };

        var dialogRef = await DialogService.ShowAsync<SubjectEditDialog>($"Edit {_title}", parameters, options);
        var result = await dialogRef.Result;

        // Force page component to reload by changing key
        if (result != null && !result.Canceled)
        {
            _componentKey++;
            StateHasChanged();
        }
    }
}
