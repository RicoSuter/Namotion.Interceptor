@page "/pages/{*Path}"

@using HomeBlaze.Abstractions
@using HomeBlaze.Components.Abstractions.Attributes
@using HomeBlaze.Host.Components.Editors
@using HomeBlaze.Services.Components
@using Namotion.Interceptor.Blazor
@using Toolbelt.Blazor.HotKeys2

@inherits HomeBlazorComponentBase
@implements IAsyncDisposable

@inject SubjectComponentRegistry ComponentRegistry
@inject SubjectPathResolver PathResolver
@inject DeveloperModeService DeveloperMode
@inject HotKeys HotKeys

<PageTitle>@_title - HomeBlaze</PageTitle>

<TrackingScope Context="_subject?.Context" ShowDebugInfo="DeveloperMode.IsEnabled">
    @if (_subject == null)
    {
        <MudAlert Severity="Severity.Warning">Subject not found at path: @Path</MudAlert>
    }
    else
    {
        @if (CanEdit())
        {
            <MudFab data-testid="edit-fab"
                    Style="position: fixed; top: 80px; right: 24px; z-index: 1000;"
                    OnClick="@ToggleEditMode"
                    StartIcon="@Icons.Material.Filled.Edit"
                    Color="Color.Primary"
                    Size="Size.Small"/>
        }

        if (_isEditMode && CanEdit())
        {
            <div data-testid="edit-splitter">
                <MudSplitter @bind-Dimension="_splitDimension"
                             Height="calc(100vh - 80px)"
                             EnableSlide="true"
                             OnDoubleClicked="ResetSplitDimension">
                <StartContent>
                    <div style="width: 100%">
                        <SubjectComponent @key="_componentKey"
                                          Subject="@_subject"
                                          Type="SubjectComponentType.Page" />
                    </div>
                </StartContent>
                <EndContent>
                    <div style="width: 100%; height: calc(100vh - 200px); overflow-y: auto;">
                        <br />
                        <br />
                        <br />
                        <SubjectEditPanel @ref="_editPanel" Subject="@_subject" />

                        <div class="d-flex justify-end gap-2 mt-4">
                            <span data-testid="save-button">
                                <MudButton Color="Color.Primary"
                                           OnClick="OnSaveClicked"
                                           Disabled="@(!(_editPanel?.IsValid ?? true))">Save (Ctrl+S)</MudButton>
                            </span>
                        </div>
                    </div>
                </EndContent>
                </MudSplitter>
            </div>
        }
        else
        {
            <SubjectComponent @key="_componentKey"
                              Subject="@_subject"
                              Type="SubjectComponentType.Page" />
        }
    }
</TrackingScope>

@code {
    [Parameter] public string? Path { get; set; }

    private IInterceptorSubject? _subject;
    private string _title = "";
    private int _componentKey;
    private bool _isEditMode;
    private double _splitDimension = 50;
    private SubjectEditPanel? _editPanel;
    private HotKeysContext? _hotKeysContext;

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _hotKeysContext = HotKeys.CreateContext()
                .Add(ModCode.Ctrl, Code.S, OnCtrlS, exclude: Exclude.None);
        }

        return Task.CompletedTask;
    }

    protected override void OnParametersSet()
    {
        LoadSubject();
        _isEditMode = false;
    }

    private void LoadSubject()
    {
        _subject = null;
        _title = "";

        var path = Path;
        if (string.IsNullOrEmpty(path) || Root is null)
            return;

        var subject = PathResolver.ResolveSubject(path, PathFormat.Slash);
        if (subject != null)
        {
            if (subject is ITitleProvider titleProvider)
            {
                _title = titleProvider.Title ?? subject.GetType().Name;
            }
            else
            {
                _title = subject.GetType().Name;
            }

            _subject = subject;
        }
    }

    private bool CanEdit()
    {
        if (_subject == null) return false;

        var hasEditComponent = ComponentRegistry.HasComponent(
            _subject.GetType(),
            SubjectComponentType.Edit);

        return hasEditComponent || _subject.HasConfigurationProperties();
    }

    private void ToggleEditMode()
    {
        _isEditMode = !_isEditMode;
    }

    private async Task OnCtrlS()
    {
        if (_isEditMode && _editPanel?.IsValid == true)
        {
            await OnSaveClicked();
        }
    }

    private async Task OnSaveClicked()
    {
        if (_editPanel != null)
        {
            await _editPanel.SaveAsync();
            // Increment key to refresh page component with saved changes
            _componentKey++;
            StateHasChanged();
        }
    }

    private void ResetSplitDimension()
    {
        _splitDimension = 50;
    }

    public async ValueTask DisposeAsync()
    {
        if (_hotKeysContext != null)
        {
            await _hotKeysContext.DisposeAsync();
        }
    }
}
