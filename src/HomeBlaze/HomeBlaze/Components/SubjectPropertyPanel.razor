@using System.Reflection
@using HomeBlaze.Abstractions
@using HomeBlaze.Abstractions.Attributes
@using Namotion.Interceptor.Registry.Abstractions

@inject IDialogService DialogService

@inherits HomeBlazorComponentBase

@if (Subject != null)
{
    @* Header *@
    <MudListSubheader Class="pa-0">
        @if (CanClose)
        {
            <MudFab OnClick="@(() => OnClose.InvokeAsync())"
                    Color="Color.Primary"
                    StartIcon="@Icons.Material.Filled.Close"
                    Size="Size.Small"
                    Style="float: right; margin-right: 5px" />
        }

        <h1 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; font-size: 1.25rem;">
            <MudIcon Size="Size.Small" Icon="@GetSubjectIcon(Subject)" />
            @GetSubjectTitle()
        </h1>
        <MudText Typo="Typo.caption" Color="Color.Secondary">@Subject.GetType().Name</MudText>
    </MudListSubheader>

    <div style="height: calc(100% - 70px); overflow-y: auto; padding-top: 16px;">
        @* Action Buttons *@
        <div class="mb-4">
            @if (HasConfigurationProperties())
            {
                <MudIconButton OnClick="@OpenConfigurationDialog"
                               Icon="@Icons.Material.Filled.Edit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               Class="mr-2" />
            }
            <MudIconButton OnClick="@(() => OnDelete.InvokeAsync())"
                           Icon="@Icons.Material.Filled.Delete"
                           Variant="Variant.Filled"
                           Color="Color.Error"
                           Size="Size.Small"
                           Class="mr-2" />
        </div>

        @* Primitive Properties *@
        @foreach (var prop in GetPrimitiveProperties())
        {
            var value = prop.GetValue();
            <MudText Style="@(value is null ? "opacity: 0.5" : "")" Class="mb-1">
                <strong>@GetPropertyDisplayName(prop): </strong>
                @RenderPropertyValue(prop, value)
            </MudText>
        }

        @if (GetPrimitiveProperties().Any())
        {
            <br />
        }

        @* Child Collections *@
        @foreach (var property in GetChildProperties())
        {
            var children = property.Children;
            @if (children.Length == 1)
            {
                @* Single child - no expansion panel *@
                <MudList T="object" Dense="true" Class="pa-0">
                    @{
                        var child = children[0];
                        var isSelected = child.Subject == SelectedChild;
                    }
                    <MudListItem Value="@child"
                                 OnClick="@(() => OnPropertyClick.InvokeAsync(new PropertyClickEventArgs(property.Name, child.Index, child.Subject)))"
                                 Icon="@GetSubjectIcon(child.Subject)"
                                 IconColor="Color.Default">
                        @if (isSelected)
                        {
                            <div style="float: right; line-height: 0">
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                            </div>
                        }
                        @GetSubjectDisplayName(child)
                        @if (HasChildren(child))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Dark" Class="ml-2">@GetChildCount(child)</MudChip>
                        }
                    </MudListItem>
                    <MudDivider />
                </MudList>
            }
            else if (children.Length > 1)
            {
                <MudExpansionPanel Dense="true" Expanded="true">
                    <TitleContent>
                        @GetPropertyDisplayName(property)
                        <MudChip T="string" Size="Size.Small" Color="Color.Dark" Class="ml-2">@children.Length</MudChip>
                    </TitleContent>
                    <ChildContent>
                        <MudList T="object" Dense="true" Class="pa-0">
                            @foreach (var child in children)
                            {
                                var isSelected = child.Subject == SelectedChild;
                                <MudListItem Value="@child"
                                             OnClick="@(() => OnPropertyClick.InvokeAsync(new PropertyClickEventArgs(property.Name, child.Index, child.Subject)))"
                                             Icon="@GetSubjectIcon(child.Subject)"
                                             IconColor="Color.Default">
                                    @if (isSelected)
                                    {
                                        <div style="float: right; line-height: 0">
                                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                                        </div>
                                    }
                                    @GetSubjectDisplayName(child)
                                    @if (HasChildren(child))
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Dark" Class="ml-2">@GetChildCount(child)</MudChip>
                                    }
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    </ChildContent>
                </MudExpansionPanel>
            }
        }

        @* Details Accordion *@
        <br />
        <MudExpansionPanels MultiExpansion="true" Elevation="0" Dense="true">
            <MudExpansionPanel Text="Details" Expanded="false">
                <div class="ml-4">
                    <small style="word-break: break-all">
                        <p><strong>Path:</strong> @GetObjectPath()</p>
                        <p><strong>Type:</strong> @Subject.GetType().FullName</p>
                    </small>
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </div>
}

@code {
    [Parameter]
    public IInterceptorSubject? Subject { get; set; }

    [Parameter]
    public ISubjectRegistry? SubjectRegistry { get; set; }

    [Parameter]
    public IInterceptorSubject? SelectedChild { get; set; }

    [Parameter]
    public bool CanClose { get; set; }

    [Parameter]
    public string? ObjectPath { get; set; }

    [Parameter]
    public EventCallback<PropertyClickEventArgs> OnPropertyClick { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback OnDelete { get; set; }

    private RegisteredSubject? _registeredSubject;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        _registeredSubject = Subject != null && SubjectRegistry != null
            ? SubjectRegistry.TryGetRegisteredSubject(Subject)
            : null;
    }

    private string GetSubjectTitle()
    {
        return Subject switch
        {
            null => "No Selection",
            ITitleProvider titleProvider when !string.IsNullOrEmpty(titleProvider.Title) => titleProvider.Title,
            _ => Subject.GetType().Name
        };
    }

    private string GetSubjectIcon(IInterceptorSubject? subject)
    {
        if (subject is IIconProvider iconProvider && !string.IsNullOrEmpty(iconProvider.Icon))
            return iconProvider.Icon;

        return Icons.Material.Filled.QuestionMark;
    }

    private string GetObjectPath()
    {
        return ObjectPath ?? "Root";
    }

    private IEnumerable<RegisteredSubjectProperty> GetPrimitiveProperties()
    {
        EnsureSubjectRegistered();

        if (_registeredSubject == null)
            return [];

        return _registeredSubject.Properties
            .Where(p => HasStateAttribute(p) && !HasChildSubjects(p))
            .OrderBy(GetStateOrder);
    }

    private IEnumerable<RegisteredSubjectProperty> GetChildProperties()
    {
        EnsureSubjectRegistered();

        if (_registeredSubject == null)
            return [];

        return _registeredSubject.Properties
            .Where(p => !p.IsAttribute && HasChildSubjects(p))
            .OrderBy(GetStateOrder);
    }

    private void EnsureSubjectRegistered()
    {
        if (_registeredSubject != null || Subject == null || SubjectRegistry == null)
            return;

        // Access all properties to trigger registration
        var props = Subject.GetType().GetProperties(BindingFlags.Public | BindingFlags.Instance);
        foreach (var prop in props)
        {
            if (prop.CanRead)
            {
                try
                {
                    _ = prop.GetValue(Subject);
                }
                catch
                {
                    // Ignore errors accessing properties
                }
            }
        }

        // Try to get registered subject again
        _registeredSubject = SubjectRegistry.TryGetRegisteredSubject(Subject);
    }

    private bool HasStateAttribute(RegisteredSubjectProperty property)
    {
        return property.Reference.Metadata.Attributes.OfType<StateAttribute>().Any();
    }

    private StateAttribute? GetStateAttribute(RegisteredSubjectProperty property)
    {
        return property.Reference.Metadata.Attributes.OfType<StateAttribute>().FirstOrDefault();
    }

    private int GetStateOrder(RegisteredSubjectProperty property)
    {
        return GetStateAttribute(property)?.Order ?? int.MaxValue;
    }

    private string GetPropertyDisplayName(RegisteredSubjectProperty property)
    {
        var stateAttr = GetStateAttribute(property);
        return stateAttr?.Name ?? property.Name;
    }

    private bool HasChildSubjects(RegisteredSubjectProperty property)
    {
        return property.HasChildSubjects;
    }

    private string RenderPropertyValue(RegisteredSubjectProperty prop, object? value)
    {
        if (value == null) return "null";

        // Use StateAttribute's GetDisplayText for unit formatting
        var stateAttr = GetStateAttribute(prop);
        if (stateAttr != null && stateAttr.Unit != StateUnit.Default)
        {
            return stateAttr.GetDisplayText(value);
        }

        // Default formatting for common types
        return value switch
        {
            bool b => b ? "Yes" : "No",
            DateTime dt => dt.ToString("g"),
            DateTimeOffset dto => dto.ToString("g"),
            TimeSpan ts => ts.ToString(@"hh\:mm\:ss"),
            Enum e => e.ToString(),
            _ => value.ToString() ?? ""
        };
    }

    private string GetSubjectDisplayName(SubjectPropertyChild child)
    {
        var subject = child.Subject;
        if (subject is ITitleProvider titleProvider && !string.IsNullOrEmpty(titleProvider.Title))
            return titleProvider.Title;

        return subject?.ToString() ?? "n/a";
    }

    private bool HasChildren(SubjectPropertyChild child)
    {
        var subject = child.Subject;
        var registered = SubjectRegistry?.TryGetRegisteredSubject(subject);
        return registered != null && 
               registered.Properties.Any(p => !p.IsAttribute && HasChildSubjects(p));
    }

    private int GetChildCount(SubjectPropertyChild child)
    {
        var subject = child.Subject;
        var registered = SubjectRegistry?.TryGetRegisteredSubject(subject);
        if (registered == null) return 0;

        return registered.Properties
            .Where(p => !p.IsAttribute && HasChildSubjects(p))
            .Sum(p => p.Children.Length);
    }

    public record PropertyClickEventArgs(string PropertyName, object? Index, IInterceptorSubject Subject);

    private bool HasConfigurationProperties()
    {
        if (_registeredSubject == null)
            return false;

        return _registeredSubject.Properties.Any(p =>
            p.Reference.Metadata.Attributes.OfType<ConfigurationAttribute>().Any());
    }

    private async Task OpenConfigurationDialog()
    {
        if (Subject == null) return;

        var parameters = new DialogParameters<SubjectConfigurationDialog>
        {
            { x => x.Subject, Subject }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var title = GetSubjectTitle();
        await DialogService.ShowAsync<SubjectConfigurationDialog>($"Edit {title}", parameters, options);
    }
}
