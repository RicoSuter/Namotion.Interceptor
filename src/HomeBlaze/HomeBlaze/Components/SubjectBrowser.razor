@using Namotion.Interceptor
@using Namotion.Interceptor.Registry.Abstractions
@inherits HomeBlazorComponentBase
@inject NavigationManager NavigationManager

<MudStack Row="true" Class="browser-toolbar mb-2">
    <MudBreadcrumbs Items="_breadcrumbs" />
    <MudSpacer />
</MudStack>

<MudStack Row="true" Class="miller-columns" Style="overflow-x: auto; min-height: 400px;">
    @foreach (var pane in _panes)
    {
        <MudPaper Class="subject-pane" Elevation="1" Style="width: 300px; min-width: 300px; max-width: 300px; overflow-y: auto; padding: 16px;">
            <SubjectPropertyPanel
                Subject="@pane.Subject"
                SubjectRegistry="@_subjectRegistry"
                OnPropertyClick="@((args) => OnPropertyClick(pane, args.PropertyName, args.Index, args.Subject))" />
        </MudPaper>
    }
</MudStack>

<style>
    .miller-columns {
        gap: 8px;
    }
    .subject-pane {
        overflow-y: auto;
    }
</style>

@code {
    [Parameter]
    public string? Path { get; set; }

    private List<SubjectPane> _panes = new();
    private List<BreadcrumbItem> _breadcrumbs = new();
    private string? _lastNavigatedUrl;
    private ISubjectRegistry? _subjectRegistry;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        // Only rebuild if this is the initial load (no panes yet)
        // or if Path changed externally (not from our own navigation)
        if (_panes.Count == 0)
        {
            RebuildFromPath();
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        var uri = new Uri(e.Location);

        // Skip if this is our own programmatic navigation
        if (_lastNavigatedUrl != null && uri.AbsolutePath == _lastNavigatedUrl)
        {
            _lastNavigatedUrl = null;
            return;
        }

        var segments = uri.AbsolutePath.TrimStart('/').Split('/');
        if (segments.Length > 0 && segments[0] == "browser")
        {
            var decodedSegments = segments.Skip(1).Select(Uri.UnescapeDataString);
            Path = string.Join("/", decodedSegments);
            RebuildFromPath();
            InvokeAsync(StateHasChanged);
        }
    }

    private void RebuildFromPath()
    {
        _panes.Clear();
        _breadcrumbs.Clear();

        if (Root == null) return;

        // Get registry from root's context
        _subjectRegistry = RootContext?.GetService<ISubjectRegistry>();

        // Always show root as first pane
        _panes.Add(new SubjectPane { Subject = Root, DisplayName = "Root", PropertyName = null, Index = null });
        _breadcrumbs.Add(new BreadcrumbItem("Root", "/browser"));

        if (string.IsNullOrEmpty(Path))
            return;

        var pathSegments = Path.Split('/', StringSplitOptions.RemoveEmptyEntries)
            .Select(Uri.UnescapeDataString)
            .ToArray();

        IInterceptorSubject currentSubject = Root;
        var currentPathParts = new List<string>();
        RegisteredSubjectProperty? pendingProperty = null;

        for (int i = 0; i < pathSegments.Length; i++)
        {
            var segment = pathSegments[i];

            if (pendingProperty == null)
            {
                // Expecting a property name
                var registered = _subjectRegistry?.TryGetRegisteredSubject(currentSubject);
                if (registered == null)
                    break;

                var property = registered.TryGetProperty(segment);
                if (property == null || !property.HasChildSubjects)
                    break;

                currentPathParts.Add(segment);

                // If it's a single subject reference, navigate directly
                if (property.IsSubjectReference)
                {
                    var child = property.GetValue() as IInterceptorSubject;
                    if (child == null)
                        break;

                    var breadcrumbPath = "/browser/" + string.Join("/", currentPathParts);
                    _breadcrumbs.Add(new BreadcrumbItem(segment, breadcrumbPath));
                    _panes.Add(new SubjectPane { Subject = child, DisplayName = segment, PropertyName = segment, Index = null });
                    currentSubject = child;
                }
                else
                {
                    // Collection or dictionary - next segment will be the index/key
                    pendingProperty = property;
                }
            }
            else
            {
                // Expecting an index/key for the pending property
                var child = FindChildByIndex(pendingProperty, segment);
                if (child == null)
                    break;

                currentPathParts.Add(segment);
                var breadcrumbPath = "/browser/" + string.Join("/", currentPathParts);
                var displayName = $"{pendingProperty.Name}[{segment}]";
                _breadcrumbs.Add(new BreadcrumbItem(displayName, breadcrumbPath));
                _panes.Add(new SubjectPane { Subject = child, DisplayName = displayName, PropertyName = pendingProperty.Name, Index = segment });
                currentSubject = child;
                pendingProperty = null;
            }
        }
    }

    private IInterceptorSubject? FindChildByIndex(RegisteredSubjectProperty property, string indexStr)
    {
        foreach (var child in property.Children)
        {
            var childIndex = child.Index?.ToString();
            if (childIndex == indexStr)
            {
                return child.Subject;
            }
        }
        return null;
    }

    private void OnPropertyClick(SubjectPane clickedPane, string propertyName, object? index, IInterceptorSubject subject)
    {
        // Find the index of the clicked pane
        var paneIndex = _panes.IndexOf(clickedPane);
        if (paneIndex < 0) return;

        // Remove all panes after the clicked one
        while (_panes.Count > paneIndex + 1)
        {
            _panes.RemoveAt(_panes.Count - 1);
        }

        // Build display name
        var displayName = index != null ? $"{propertyName}[{index}]" : propertyName;

        // Add the new subject pane
        _panes.Add(new SubjectPane { Subject = subject, DisplayName = displayName, PropertyName = propertyName, Index = index });

        UpdateUrl();
        StateHasChanged();
    }

    private void UpdateUrl()
    {
        var pathParts = new List<string>();

        // Skip the first pane (root) when building path
        foreach (var pane in _panes.Skip(1))
        {
            // Add property name
            if (pane.PropertyName != null)
            {
                pathParts.Add(Uri.EscapeDataString(pane.PropertyName));
            }

            // Add index/key if present (for collections/dictionaries)
            if (pane.Index != null)
            {
                pathParts.Add(Uri.EscapeDataString(pane.Index.ToString()!));
            }
        }

        var url = "/browser" + (pathParts.Any() ? "/" + string.Join("/", pathParts) : "");

        // Store the URL so OnLocationChanged knows to ignore this navigation
        _lastNavigatedUrl = url;
        NavigationManager.NavigateTo(url, replace: true);

        // Rebuild breadcrumbs
        _breadcrumbs.Clear();
        _breadcrumbs.Add(new BreadcrumbItem("Root", "/browser"));

        var breadcrumbParts = new List<string>();
        foreach (var pane in _panes.Skip(1))
        {
            if (pane.PropertyName != null)
            {
                breadcrumbParts.Add(Uri.EscapeDataString(pane.PropertyName));
            }
            if (pane.Index != null)
            {
                breadcrumbParts.Add(Uri.EscapeDataString(pane.Index.ToString()!));
            }

            var breadcrumbPath = "/browser/" + string.Join("/", breadcrumbParts);
            _breadcrumbs.Add(new BreadcrumbItem(pane.DisplayName, breadcrumbPath));
        }
    }

    public override void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        base.Dispose();
    }

    private class SubjectPane
    {
        public IInterceptorSubject Subject { get; set; } = null!;
        public string DisplayName { get; set; } = "";
        public string? PropertyName { get; set; }
        public object? Index { get; set; }
    }
}
