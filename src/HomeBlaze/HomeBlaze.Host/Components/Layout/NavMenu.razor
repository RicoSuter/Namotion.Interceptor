@inject RootManager RootManager
@inject NavigationItemResolver NavigationResolver

@implements IDisposable

<MudNavMenu>
    @if (RootManager.Root != null)
    {
        @foreach (var item in GetRootItems())
        {
            @if (item.IsPage && !item.IsFolder)
            {
                <MudNavLink Href="@($"pages/{item.Path}")"
                            Match="NavLinkMatch.All"
                            Icon="@SubjectIconExtensions.ResolveMudBlazorIcon(item.Icon)">
                    @item.Title
                </MudNavLink>
            }
            else if (item.IsFolder)
            {
                <NavFolder Item="item" NavigationResolver="NavigationResolver" />
            }
        }
    }

    <MudDivider Class="my-2" />
    <MudNavLink Href="browser"
                Match="NavLinkMatch.Prefix"
                Icon="@Icons.Material.Filled.FolderOpen">
        Browser
    </MudNavLink>
</MudNavMenu>

@code {
    private Timer? _refreshTimer;

    protected override void OnInitialized()
    {
        // Periodically refresh to catch new files
        _refreshTimer = new Timer(_ => InvokeAsync(StateHasChanged),
            null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private IEnumerable<NavigationItem> GetRootItems()
    {
        if (RootManager.Root == null)
            return Enumerable.Empty<NavigationItem>();

        try
        {
            return NavigationResolver.GetChildItems(RootManager.Root);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting navigation items: {ex}");
            return Enumerable.Empty<NavigationItem>();
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
