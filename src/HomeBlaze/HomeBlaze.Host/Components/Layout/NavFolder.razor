@using HomeBlaze.Components.Abstractions.Pages

@inject AuthenticationStateProvider AuthStateProvider
@inject IAuthorizationResolver AuthorizationResolver
@inject IRoleExpander RoleExpander

<MudNavGroup Title="@Item.Title" Icon="@SubjectIconExtensions.ResolveMudBlazorIcon(Item.Icon)" Expanded="_expanded" ExpandedChanged="OnExpandedChanged">
    @if (_expanded && _children != null)
    {
        @foreach (var child in _children.Where(c => c.Location == NavigationLocation.NavBar))
        {
            @if (child is { IsPage: true, IsFolder: false })
            {
                <MudNavLink Href="@child.PageUrl"
                            Match="NavLinkMatch.All"
                            Icon="@SubjectIconExtensions.ResolveMudBlazorIcon(child.Icon)">
                    @child.Title
                </MudNavLink>
            }
            else if (child.IsFolder)
            {
                <NavFolder Item="child" NavigationResolver="NavigationResolver" CurrentPath="@CurrentPath" />
            }
        }
    }
</MudNavGroup>

@code {
    [Parameter, EditorRequired]
    public required NavigationItem Item { get; set; }

    [Parameter, EditorRequired]
    public required NavigationItemResolver NavigationResolver { get; set; }

    [Parameter]
    public string CurrentPath { get; set; } = string.Empty;

    private bool _expanded;
    private List<NavigationItem>? _children;
    private string? _lastCurrentPath;
    private IReadOnlySet<string>? _userExpandedRoles;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRolesAsync();
    }

    private async Task LoadUserRolesAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                var userRoles = user.Claims
                    .Where(c => c.Type == System.Security.Claims.ClaimTypes.Role)
                    .Select(c => c.Value)
                    .ToList();
                _userExpandedRoles = RoleExpander.ExpandRoles(userRoles);
            }
            else
            {
                _userExpandedRoles = RoleExpander.ExpandRoles(["Anonymous"]);
            }
        }
        catch
        {
            _userExpandedRoles = RoleExpander.ExpandRoles(["Anonymous"]);
        }
    }

    protected override void OnParametersSet()
    {
        // Auto-expand if current page is inside this folder
        if (CurrentPath != _lastCurrentPath)
        {
            _lastCurrentPath = CurrentPath;
            if (!string.IsNullOrEmpty(CurrentPath) && IsCurrentPageInFolder())
            {
                _expanded = true;
                _children ??= GetFilteredChildren();
            }
        }
    }

    private bool IsCurrentPageInFolder()
    {
        // Check if current path starts with this folder's path
        // Item.PageUrl is like "pages/Children/demo" for a folder
        // CurrentPath would be like "pages/Children/demo/Children/Setup.md"
        var folderPath = Item.PageUrl.TrimEnd('/');
        return CurrentPath.StartsWith(folderPath + "/", StringComparison.OrdinalIgnoreCase) ||
               CurrentPath.Equals(folderPath, StringComparison.OrdinalIgnoreCase);
    }

    private void OnExpandedChanged(bool expanded)
    {
        _expanded = expanded;
        if (_expanded && _children == null)
        {
            _children = GetFilteredChildren();
        }
    }

    private List<NavigationItem> GetFilteredChildren()
    {
        var items = NavigationResolver.GetChildItems(Item.Subject);
        return items.Where(CanReadSubject).ToList();
    }

    private bool CanReadSubject(NavigationItem item)
    {
        if (_userExpandedRoles == null)
            return true;

        var requiredRoles = AuthorizationResolver.ResolveSubjectRoles(
            item.Subject,
            AuthorizationEntity.State,
            AuthorizationAction.Read);

        return requiredRoles.Any(r => _userExpandedRoles.Contains(r));
    }
}
