@using System.ComponentModel
@using System.Reflection
@using HomeBlaze.Abstractions
@using HomeBlaze.Components.Abstractions
@using HomeBlaze.Components.Abstractions.Attributes
@using HomeBlaze.Services
@using HomeBlaze.Services.Components
@using MudBlazor
@using Namotion.Interceptor

@inject SubjectTypeRegistry TypeRegistry
@inject SubjectComponentRegistry ComponentRegistry
@inject SubjectFactory SubjectFactory

<MudDialog data-testid="create-subject-wizard">
    <TitleContent>
        @if (_activeStep == 0)
        {
            <MudText Typo="Typo.h6">Step 1: Select Type</MudText>
        }
        else
        {
            <MudText Typo="Typo.h6">Step 2: Create @(_selectedType?.Name ?? "Subject")</MudText>
        }
    </TitleContent>
    <DialogContent>
        <MudStepper @bind-ActiveIndex="_activeStep"
                    Linear="true"
                    OnPreviewInteraction="OnPreviewInteraction"
                    Class="mud-width-full"
                    data-testid="create-wizard-stepper">
            <MudStep Title="Select Type">
                <div style="max-height: 400px; overflow-y: auto;">
                    @foreach (var category in GetGroupedTypes())
                    {
                        <MudExpansionPanels MultiExpansion="true" data-testid="@($"category-panel-{category.Key.ToLowerInvariant()}")">
                            <MudExpansionPanel IsInitiallyExpanded="true" Text="@category.Key">
                                <MudGrid Spacing="2">
                                    @foreach (var type in category.Value)
                                    {
                                        <MudItem xs="12" sm="6">
                                            <MudCard Outlined="true"
                                                     Class="@(_selectedType == type ? "mud-border-primary" : "")"
                                                     Style="cursor: pointer;"
                                                     @onclick="() => SelectType(type)"
                                                     data-testid="@($"type-card-{type.Name.ToLowerInvariant()}")">
                                                <MudCardContent>
                                                    <MudText Typo="Typo.subtitle1">@type.Name</MudText>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                        @(type.GetCustomAttribute<DescriptionAttribute>()?.Description ?? "No description")
                                                    </MudText>
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    }
                </div>
            </MudStep>
            <MudStep Title="Configure">
                @if (_selectedType != null && _createdSubject != null)
                {
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="_subjectName"
                                      Label="Name"
                                      Required="true"
                                      RequiredError="Name is required"
                                      HelperText="@($"{_subjectName}.json")"
                                      Immediate="true"
                                      data-testid="create-name-input" />

                        <MudDivider />

                        @if (_editComponentType != null)
                        {
                            <DynamicComponent Type="_editComponentType"
                                              Parameters="@(new Dictionary<string, object?>
                                              {
                                                  { "Subject", _createdSubject },
                                                  { "IsCreating", true }
                                              })" />
                        }
                    </MudStack>
                }
            </MudStep>
        </MudStepper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel"
                   data-testid="cancel-button">Cancel</MudButton>
        @if (_activeStep > 0)
        {
            <MudButton OnClick="GoBack"
                       data-testid="back-button">Back</MudButton>
        }
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@(!CanCreate)"
                   OnClick="Create"
                   data-testid="create-button">Create</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private int _activeStep = 0;
    private Type? _selectedType;
    private IInterceptorSubject? _createdSubject;
    private Type? _editComponentType;
    private string _subjectName = "";

    private bool CanCreate => _activeStep == 1
        && !string.IsNullOrWhiteSpace(_subjectName)
        && _createdSubject != null;

    private Dictionary<string, List<Type>> GetGroupedTypes()
    {
        return TypeRegistry.RegisteredTypes
            .Where(t => typeof(IConfigurableSubject).IsAssignableFrom(t))
            .Where(t => t.GetCustomAttribute<System.ComponentModel.CategoryAttribute>() != null)
            .GroupBy(t => t.GetCustomAttribute<System.ComponentModel.CategoryAttribute>()!.Category)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private void SelectType(Type type)
    {
        _selectedType = type;
        _createdSubject = SubjectFactory.CreateSubject(type);
        _subjectName = type.Name.ToLowerInvariant();

        // Find edit component
        var setupComponent = ComponentRegistry.GetComponent(type, SubjectComponentType.Setup);
        var editComponent = ComponentRegistry.GetComponent(type, SubjectComponentType.Edit);
        _editComponentType = setupComponent?.ComponentType ?? editComponent?.ComponentType;

        // Advance to step 2
        _activeStep = 1;
    }

    private Task OnPreviewInteraction(StepperInteractionEventArgs args)
    {
        // Prevent going forward without selection
        if (args.StepIndex > _activeStep && _selectedType == null)
        {
            args.Cancel = true;
        }
        return Task.CompletedTask;
    }

    private void GoBack()
    {
        _activeStep = 0;
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private void Create()
    {
        if (_createdSubject != null && !string.IsNullOrWhiteSpace(_subjectName))
        {
            MudDialog?.Close(DialogResult.Ok(new CreateSubjectResult(_createdSubject, _subjectName)));
        }
    }

    /// <summary>
    /// Shows the create subject wizard and returns the result.
    /// </summary>
    public static async Task<CreateSubjectResult?> ShowAsync(IDialogService dialogService)
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await dialogService.ShowAsync<CreateSubjectWizard>("Create Subject", options);
        var result = await dialog.Result;

        if (result?.Canceled != false)
            return null;

        return result.Data as CreateSubjectResult;
    }
}
