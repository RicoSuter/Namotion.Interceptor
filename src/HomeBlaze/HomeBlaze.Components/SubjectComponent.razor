@inject SubjectComponentRegistry ComponentRegistry
@inject IDialogService DialogService

@if (Subject != null)
{
    var registration = ComponentRegistry.GetComponent(Subject.GetType(), Type);
    if (registration?.ComponentType != null)
    {
        <div class="subject-component-wrapper" style="position: relative;">
            @if (IsEditing && Type == SubjectComponentType.Widget && (ActionButtons != null || HasEditComponent))
            {
                <div class="subject-edit-overlay">
                    @* Built-in edit button (if edit component exists) *@
                    @if (HasEditComponent)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       title="Edit"
                                       OnClick="OpenEditDialog"
                                       data-testid="edit-subject-button" />
                    }

                    @* Additional action buttons from parent *@
                    @ActionButtons
                </div>
            }
            <DynamicComponent Type="registration.ComponentType"
                              @ref="_dynamicComponent"
                              Parameters="@GetComponentParameters()" />
        </div>
    }
    else
    {
        <MudAlert Severity="Severity.Warning" Dense="true">
            No @Type component for @Subject.GetType().Name
        </MudAlert>
    }
}

<style>
    .subject-edit-overlay {
        position: absolute;
        top: 4px;
        right: 4px;
        z-index: 10;
        display: flex;
        gap: 2px;
        background: rgba(255,255,255,0.95);
        border-radius: 4px;
        padding: 2px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        opacity: 0.9;
    }
    .subject-edit-overlay:hover {
        opacity: 1;
    }
    .subject-edit-overlay .mud-icon-button {
        padding: 4px;
    }
</style>

@code {
    private DynamicComponent? _dynamicComponent;

    [Parameter]
    public IInterceptorSubject? Subject { get; set; }

    [Parameter]
    public SubjectComponentType Type { get; set; }

    /// <summary>
    /// Additional action buttons to display in the edit overlay.
    /// Rendered after the built-in edit button.
    /// </summary>
    [Parameter]
    public RenderFragment? ActionButtons { get; set; }

    /// <summary>
    /// Additional parameters to pass to the rendered component (e.g., IsCreating).
    /// </summary>
    [Parameter]
    public Dictionary<string, object?>? AdditionalParameters { get; set; }

    [CascadingParameter(Name = "IsEditing")]
    public bool IsEditing { get; set; }

    /// <summary>
    /// Two-way binding for accessing the rendered component instance.
    /// Useful for edit panels that need to access ISubjectEditComponent methods.
    /// </summary>
    [Parameter]
    public ISubjectComponent? ComponentInstance { get; set; }

    [Parameter]
    public EventCallback<ISubjectComponent?> ComponentInstanceChanged { get; set; }

    private bool HasEditComponent =>
        Subject != null &&
        ComponentRegistry.HasComponent(Subject.GetType(), SubjectComponentType.Edit);

    private Dictionary<string, object?> GetComponentParameters()
    {
        var parameters = new Dictionary<string, object?> { ["Subject"] = Subject };

        if (AdditionalParameters != null)
        {
            foreach (var kvp in AdditionalParameters)
            {
                parameters[kvp.Key] = kvp.Value;
            }
        }

        return parameters;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var instance = _dynamicComponent?.Instance as ISubjectComponent;
        if (instance != ComponentInstance)
        {
            ComponentInstance = instance;
            await ComponentInstanceChanged.InvokeAsync(instance);
        }
    }

    private async Task OpenEditDialog()
    {
        if (Subject == null)
            return;

        // Use dynamic type lookup for SubjectEditDialog since it's in HomeBlaze.Host
        var dialogType = System.Type.GetType("HomeBlaze.Host.Components.Dialogs.SubjectEditDialog, HomeBlaze.Host");
        if (dialogType == null)
            return;

        var parameters = new DialogParameters<object>
        {
            { "Subject", Subject }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        await DialogService.ShowAsync(dialogType, "Edit", parameters, options);
    }
}
