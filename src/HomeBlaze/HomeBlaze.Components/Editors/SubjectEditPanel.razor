@using HomeBlaze.Abstractions
@using HomeBlaze.Services
@using HomeBlaze.Storage.Abstractions
@using Namotion.Interceptor.Tracking.Parent

@implements IAsyncDisposable

@inject RootManager RootManager
@inject SubjectComponentRegistry ComponentRegistry
@inject ISnackbar Snackbar
@inject DeveloperModeService DeveloperMode

<TrackingScope Context="Subject?.Context" ShowDebugInfo="DeveloperMode.IsEnabled">
    @if (Subject != null)
    {
        @if (ComponentRegistry.HasComponent(Subject.GetType(), SubjectComponentType.Edit))
        {
            <SubjectComponent Subject="@Subject"
                              Type="SubjectComponentType.Edit"
                              @bind-ComponentInstance="_subjectComponent" />
        }
        else
        {
            <ConfigurationPropertiesEditor @ref="_propertiesEditor" Subject="@Subject" />
        }
    }
</TrackingScope>

@code {
    [Parameter] public IInterceptorSubject? Subject { get; set; }

    private ISubjectComponent? _subjectComponent;
    private ISubjectEditComponent? _editComponent;
    private ConfigurationPropertiesEditor? _propertiesEditor;

    public bool IsValid => _editComponent?.IsValid ?? _propertiesEditor?.IsValid ?? true;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Unsubscribe from previous edit component
        if (_editComponent != null)
        {
            _editComponent.IsValidChanged -= OnIsValidChanged;
            _editComponent.IsDirtyChanged -= OnIsDirtyChanged;
            _editComponent = null;
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        // Subscribe to new edit component if available
        if (_subjectComponent is ISubjectEditComponent editComponent && _editComponent != editComponent)
        {
            if (_editComponent != null)
            {
                _editComponent.IsValidChanged -= OnIsValidChanged;
                _editComponent.IsDirtyChanged -= OnIsDirtyChanged;
            }

            _editComponent = editComponent;
            _editComponent.IsValidChanged += OnIsValidChanged;
            _editComponent.IsDirtyChanged += OnIsDirtyChanged;
            StateHasChanged();
        }
    }

    private void OnIsValidChanged(bool isValid) => InvokeAsync(StateHasChanged);

    private void OnIsDirtyChanged(bool isDirty) => InvokeAsync(StateHasChanged);

    public async Task SaveAsync()
    {
        var subject = Subject;
        if (subject == null) return;

        try
        {
            if (_editComponent != null)
            {
                if (!_editComponent.IsValid)
                {
                    return;
                }

                await _editComponent.SaveAsync(CancellationToken.None);
            }
            else
            {
                if (_propertiesEditor?.HasErrors == true)
                {
                    return;
                }

                _propertiesEditor?.ApplyChanges();
            }

            if (subject is IConfigurableSubject)
            {
                var configurationWriter = FindNearestConfigurationWriter(subject);
                await configurationWriter.WriteConfigurationAsync(subject, CancellationToken.None);
            }

            if (subject is IStorageFile storageFile)
            {
                await storageFile.OnFileChangedAsync(CancellationToken.None);
            }

            if (subject is IConfigurableSubject configurableSubject)
            {
                await configurableSubject.ApplyConfigurationAsync(CancellationToken.None);
            }

            Snackbar.Add("Configuration saved.", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving configuration: {ex.Message}", Severity.Error);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_editComponent != null)
        {
            _editComponent.IsValidChanged -= OnIsValidChanged;
            _editComponent.IsDirtyChanged -= OnIsDirtyChanged;
        }

        await Task.CompletedTask;
    }

    private IConfigurationWriter FindNearestConfigurationWriter(IInterceptorSubject subject)
    {
        // Check if the subject itself is a writer
        if (subject is IConfigurationWriter writer)
        {
            return writer;
        }

        // Traverse parents to find the nearest IConfigurationWriter
        var visited = new HashSet<IInterceptorSubject>();
        var current = subject;

        while (current != null)
        {
            if (!visited.Add(current))
            {
                break; // Avoid infinite loops
            }

            var parents = current.GetParents();
            if (parents.Count == 0)
            {
                break;
            }

            // Get the first parent's subject
            var parentSubject = parents.First().Property.Subject;
            if (parentSubject is IConfigurationWriter parentWriter)
            {
                return parentWriter;
            }

            current = parentSubject;
        }

        return RootManager;
    }
}
