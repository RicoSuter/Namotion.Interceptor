@using System.ComponentModel
@using System.Reflection
@using HomeBlaze.Components.Editors

@inject SubjectTypeRegistry TypeRegistry
@inject SubjectFactory SubjectFactory
@inject ISnackbar Snackbar

<MudDialog data-testid="create-subject-wizard" Style="height: calc(100vh - 200px);">
    <TitleContent>
        <MudText Typo="Typo.h6">@GetTitle()</MudText>
    </TitleContent>
    <DialogContent>
        <MudTabs @bind-ActivePanelIndex="_activeStep"
                 Elevation="0"
                 Rounded="true"
                 ApplyEffectsToContainer="true">
            <MudTabPanel Text="Select Type">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_subjectName"
                                  Label="Name"
                                  Required="true"
                                  RequiredError="Name is required"
                                  Validation="@((Func<string?, string?>)(name => IsValidFileName(name) ? null : "Name contains invalid characters"))"
                                  HelperText="Name for the subject (will be saved as {name}.json)"
                                  Immediate="true"
                                  data-testid="create-name-input" />

                    <div style="max-height: calc(100vh - 500px); overflow-y: auto;">
                        @foreach (var category in GetGroupedTypes())
                        {
                            <div class="mb-3" data-testid="@($"category-panel-{category.Key.ToLowerInvariant()}")">
                                <MudText Typo="Typo.h6" Class="mb-2">@category.Key</MudText>
                                <MudGrid Spacing="2">
                                    @foreach (var type in category.Value)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudButton OnClick="@(() => SelectType(type))"
                                                       Variant="Variant.Outlined"
                                                       FullWidth="true"
                                                       Class="@(_selectedType == type ? "mud-border-primary" : "")"
                                                       Style="height: 100%; padding: 16px; text-align: left; text-transform: none; justify-content: flex-start;"
                                                       data-testid="@($"type-card-{type.Name.ToLowerInvariant()}")">
                                                <div style="width: 100%;">
                                                    <MudText Typo="Typo.subtitle1">@type.Name</MudText>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                        @(type.GetCustomAttribute<DescriptionAttribute>()?.Description ?? "No description")
                                                    </MudText>
                                                </div>
                                            </MudButton>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </div>
                        }
                    </div>
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Text="Configure">
                @if (_selectedType != null && _createdSubject != null)
                {
                    <SubjectEditPanel @ref="_editPanel"
                                      Subject="_createdSubject"
                                      IsCreating="true" />
                }
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel"
                   data-testid="cancel-button">Cancel</MudButton>
        @if (_activeStep > StepSelectType)
        {
            <MudButton OnClick="GoBack"
                       data-testid="back-button">Back</MudButton>
        }
        @if (_activeStep == StepSelectType && _selectedType != null)
        {
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       Disabled="@(!IsNameValid)"
                       OnClick="AdvanceToStep2"
                       data-testid="next-button">Next</MudButton>
        }
        @if (_activeStep == StepConfigure)
        {
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       Disabled="@(!CanCreate)"
                       OnClick="Create"
                       data-testid="create-button">Create</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    private const int StepSelectType = 0;
    private const int StepConfigure = 1;

    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private int _activeStep = StepSelectType;

    private Type? _selectedType;
    private IInterceptorSubject? _createdSubject;
    private SubjectEditPanel? _editPanel;
    private string _subjectName = "";

    // TODO: Invalidate cache when types can be dynamically loaded
    private Dictionary<string, List<Type>>? _groupedTypes;

    private bool IsNameValid => !string.IsNullOrWhiteSpace(_subjectName) && IsValidFileName(_subjectName);

    private bool CanCreate => _activeStep == StepConfigure
        && IsNameValid
        && _createdSubject != null
        && (_editPanel?.IsValid ?? true);

    private string GetTitle()
    {
        return _activeStep == StepSelectType
            ? "Step 1: Select Type"
            : $"Step 2: Create {_selectedType?.Name ?? "Subject"}";
    }

    private static bool IsValidFileName(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return true; // Required attribute handles empty

        return !name.Any(c => Path.GetInvalidFileNameChars().Contains(c));
    }

    private Dictionary<string, List<Type>> GetGroupedTypes()
    {
        return _groupedTypes ??= TypeRegistry.RegisteredTypes
            .Where(t => typeof(IConfigurableSubject).IsAssignableFrom(t))
            .GroupBy(t => t.GetCustomAttribute<System.ComponentModel.CategoryAttribute>()?.Category ?? "Uncategorized")
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private void SelectType(Type type)
    {
        _selectedType = type;

        // Only auto-advance if name is valid
        if (IsNameValid)
        {
            AdvanceToStep2();
        }
    }

    private void AdvanceToStep2()
    {
        if (_selectedType != null && IsNameValid)
        {
            // TODO: Consider deferring subject creation until "Create" click to avoid orphaned subjects on cancel
            _createdSubject ??= SubjectFactory.CreateSubject(_selectedType);
            _activeStep = StepConfigure;
            RefreshDialog();
        }
    }

    private void GoBack()
    {
        _activeStep = StepSelectType;
        RefreshDialog();
    }

    private void RefreshDialog()
    {
        StateHasChanged();
        MudDialog?.StateHasChanged();
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private async Task Create()
    {
        if (_createdSubject != null && !string.IsNullOrWhiteSpace(_subjectName))
        {
            try
            {
                // Save the edit component changes before creating
                if (_editPanel != null)
                {
                    await _editPanel.SaveAsync(CancellationToken.None);
                }

                MudDialog?.Close(DialogResult.Ok(new CreateSubjectResult(_createdSubject, _subjectName)));
            }
            catch (Exception exception)
            {
                Snackbar.Add($"Failed to create subject: {exception.Message}", Severity.Error);
            }
        }
    }

    /// <summary>
    /// Shows the create subject wizard and returns the result.
    /// </summary>
    public static async Task<CreateSubjectResult?> ShowAsync(IDialogService dialogService)
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await dialogService.ShowAsync<SubjectSetupDialog>("Create Subject", options);
        var result = await dialog.Result;

        if (result?.Canceled != false)
            return null;

        return result.Data as CreateSubjectResult;
    }
}
