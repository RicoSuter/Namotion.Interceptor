@using System.ComponentModel
@using System.Reflection
@using HomeBlaze.Abstractions
@using HomeBlaze.Services

@inject SubjectTypeRegistry TypeRegistry
@inject SubjectComponentRegistry ComponentRegistry
@inject SubjectFactory SubjectFactory

<MudDialog data-testid="create-subject-wizard" Style="height: calc(100vh - 200px);">
    <TitleContent>
        <MudText Typo="Typo.h6">@GetTitle()</MudText>
    </TitleContent>
    <DialogContent>
        <MudTabs @bind-ActivePanelIndex="_activeStep"
                 Elevation="0"
                 Rounded="true"
                 ApplyEffectsToContainer="true"
                 PanelClass="pa-6">
            <MudTabPanel Text="Select Type">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_subjectName"
                                  Label="Name"
                                  Required="true"
                                  RequiredError="Name is required"
                                  HelperText="Name for the subject (will be saved as {name}.json)"
                                  Immediate="true"
                                  data-testid="create-name-input" />

                    <div style="max-height: calc(100vh - 600px); overflow-y: auto;">
                        @foreach (var category in GetGroupedTypes())
                        {
                            <div class="mb-3" data-testid="@($"category-panel-{category.Key.ToLowerInvariant()}")">
                                <MudText Typo="Typo.h6" Class="mb-2">@category.Key</MudText>
                                <MudGrid Spacing="2">
                                    @foreach (var type in category.Value)
                                    {
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudButton OnClick="@(() => SelectType(type))"
                                                       Variant="Variant.Outlined"
                                                       FullWidth="true"
                                                       Class="@(_selectedType == type ? "mud-border-primary" : "")"
                                                       Style="height: 100%; padding: 16px; text-align: left; text-transform: none; justify-content: flex-start;"
                                                       data-testid="@($"type-card-{type.Name.ToLowerInvariant()}")">
                                                <div style="width: 100%;">
                                                    <MudText Typo="Typo.subtitle1">@type.Name</MudText>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                        @(type.GetCustomAttribute<DescriptionAttribute>()?.Description ?? "No description")
                                                    </MudText>
                                                </div>
                                            </MudButton>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </div>
                        }
                    </div>
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Text="Configure">
                @if (_selectedType != null && _createdSubject != null)
                {
                    @if (_editComponentType != null)
                    {
                        <DynamicComponent @ref="_editComponentRef"
                                          Type="_editComponentType"
                                          Parameters="@(new Dictionary<string, object?>
                                          {
                                              { "Subject", _createdSubject },
                                              { "IsCreating", true }
                                          })" />
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">No configuration needed for this type.</MudAlert>
                    }
                }
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel"
                   data-testid="cancel-button">Cancel</MudButton>
        @if (_activeStep > 0)
        {
            <MudButton OnClick="GoBack"
                       data-testid="back-button">Back</MudButton>
        }
        @if (_activeStep == 0 && _selectedType != null)
        {
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       Disabled="@(string.IsNullOrWhiteSpace(_subjectName))"
                       OnClick="AdvanceToStep2"
                       data-testid="next-button">Next</MudButton>
        }
        @if (_activeStep == 1)
        {
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       Disabled="@(!CanCreate)"
                       OnClick="Create"
                       data-testid="create-button">Create</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private int _activeStepValue = 0;
    private int _activeStep
    {
        get => _activeStepValue;
        set
        {
            // TODO: Just use a field and call StateHasChanged manually? => not in setter
            if (_activeStepValue != value)
            {
                _activeStepValue = value;
                StateHasChanged();
                // MudDialog TitleContent doesn't auto-update - force it
                // See: https://github.com/MudBlazor/MudBlazor/issues/7201
                MudDialog?.StateHasChanged();
            }
        }
    }

    private Type? _selectedType;
    private IInterceptorSubject? _createdSubject;
    private Type? _editComponentType;
    private DynamicComponent? _editComponentRef;
    private string _subjectName = "";

    private bool CanCreate => _activeStep == 1
        && !string.IsNullOrWhiteSpace(_subjectName)
        && _createdSubject != null;

    private string GetTitle()
    {
        return _activeStep == 0
            ? "Step 1: Select Type"
            : $"Step 2: Create {_selectedType?.Name ?? "Subject"}";
    }

    private Dictionary<string, List<Type>> GetGroupedTypes()
    {
        return TypeRegistry.RegisteredTypes
            .Where(t => typeof(IConfigurableSubject).IsAssignableFrom(t))
            .Where(t => t.GetCustomAttribute<System.ComponentModel.CategoryAttribute>() != null)
            .GroupBy(t => t.GetCustomAttribute<System.ComponentModel.CategoryAttribute>()!.Category)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private void SelectType(Type type)
    {
        _selectedType = type;
        _createdSubject = SubjectFactory.CreateSubject(type);

        // Find edit component
        var setupComponent = ComponentRegistry.GetComponent(type, SubjectComponentType.Setup);
        var editComponent = ComponentRegistry.GetComponent(type, SubjectComponentType.Edit);
        _editComponentType = setupComponent?.ComponentType ?? editComponent?.ComponentType;

        // Only auto-advance if name is already set
        if (!string.IsNullOrWhiteSpace(_subjectName))
        {
            _activeStep = 1;
        }
    }

    private void AdvanceToStep2()
    {
        if (_selectedType != null && !string.IsNullOrWhiteSpace(_subjectName))
        {
            _activeStep = 1;
        }
    }

    private void GoBack()
    {
        _activeStep = 0;
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private async Task Create()
    {
        if (_createdSubject != null && !string.IsNullOrWhiteSpace(_subjectName))
        {
            // Save the edit component changes before creating
            if (_editComponentRef?.Instance is ISubjectEditComponent editComponent)
            {
                await editComponent.SaveAsync(CancellationToken.None);
            }

            MudDialog?.Close(DialogResult.Ok(new CreateSubjectResult(_createdSubject, _subjectName)));
        }
    }

    /// <summary>
    /// Shows the create subject wizard and returns the result.
    /// </summary>
    public static async Task<CreateSubjectResult?> ShowAsync(IDialogService dialogService)
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await dialogService.ShowAsync<CreateSubjectWizard>("Create Subject", options);
        var result = await dialog.Result;

        if (result?.Canceled != false)
            return null;

        return result.Data as CreateSubjectResult;
    }
}
